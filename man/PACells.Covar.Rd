% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/PACells.R
\name{PACells.Covar}
\alias{PACells.Covar}
\title{PPACells.Covar: identify clinical phenotype-associated cell states from scATAC-seq data with covariates}
\usage{
PACells.Covar(
  sc_dataset,
  bulk_dataset,
  phenotype,
  covariates,
  motifs,
  cutoff = 0.1,
  screenRatio = 0.8,
  family = c("binomial", "gaussian", "cox")[1],
  method = c("KL", "Pearson", "Spearman")[1],
  level = TRUE,
  sc_refgenome = c("hg38", "hg19")[1],
  bulk_refgenome = c("hg38", "hg19")[1],
  res = 1,
  dims_Neighbors = 2:30,
  dims_UMAP = 2:30,
  group = NULL,
  auto_subsample = 0.7,
  auto_stab_threshold = 0.7,
  batch = c("none", "harmony", "seurat")[1],
  Batch_variable = "Sample",
  dim_Batch = 2:30
)
}
\arguments{
\item{sc_dataset}{A Seurat object containing scATAC-seq data. It should include an \code{"ATAC"} assay with
peak/bin counts and genomic ranges.}

\item{bulk_dataset}{bulk_dataset A Seurat object containing bulk ATAC-seq data. Each column represents one bulk sample.
Bulk samples should correspond to entries in \code{phenotype} and rows in \code{covariates}.}

\item{phenotype}{Phenotype annotation for bulk samples.
\itemize{
  \item For \code{family = "binomial"} and \code{family = "gaussian"}: a vector aligned to bulk samples.
  \item For \code{family = "cox"}: a two-column matrix/data.frame with survival \code{time} and event
  \code{status}, aligned to bulk samples.
}}

\item{covariates}{A data.frame of covariates for bulk samples. Rows should correspond to bulk samples in the
same order as \code{phenotype}. Columns are covariate variables. Users may include clinical
covariates that they would like to account for in the phenotype association step.}

\item{motifs}{TF motif definitions (e.g., from \code{getMotifs()}) used in the PACells workflow.}

\item{cutoff}{Maximum proportion of cells labeled as \code{"PACells"} among all single cells.
This parameter restricts the final number of selected cells.
A smaller cutoff value (default \code{10\%}) is recommended depending on the input data.
Users can adjust it depending on data size and how stringent the cell selection should be.}

\item{screenRatio}{Pre-screen candidate cells that are strongly related to the phenotype.
This parameter controls the percentage of cells retained as candidates before the final labeling step.
If a numeric value is provided, it directly specifies the proportion of cells to keep (default \code{0.80}).
If \code{screenRatio = "auto"}, PACells selects a suitable proportion by checking the stability of the
pre-screening results under repeated subsampling of bulk samples (controlled by \code{auto_subsample} and
\code{auto_stab_threshold}).}

\item{family}{Response type for the regression model. It depends on the type of the given phenotype and
can be \code{family = gaussian} for linear regression, \code{family = binomial} for classification,
or \code{family = cox} for Cox regression.}

\item{method}{Method for calculating the similarity matrix of bulk and single cells.
Options include \code{"KL"}, \code{"Pearson"}, and \code{"Spearman"}. The default is KL divergence.}

\item{level}{Logical value. If TRUE, calculating similarity based on an overall activity level profile.
If FALSE, calculating similarity based on relative activity patterns between features. The default is TRUE.}

\item{sc_refgenome}{Reference genome for the bulk ATAC-seq object ("hg38" or "hg19"). This should
match the coordinate system of the peak ranges stored in \code{bulk_dataset}.}

\item{res}{the resolution parameter (default 1) in the FindClusters function, which is used to group cells.}

\item{dims_Neighbors}{Dimensions of reduction to construct nearest-neighbor graph.}

\item{dims_UMAP}{Dimensions of reduction to UMAP.}

\item{group}{Optional user-provided grouping vector for single cells. A vector of grouping information of
single cells, when is provided by the user, this grouping is used instead of clusters computed internally.}

\item{auto_subsample}{Subsampling proportion of bulk samples used when \code{screenRatio = "auto"}.
Default is \code{0.7}.#'}

\item{auto_stab_threshold}{Stability threshold used when \code{screenRatio = "auto"}.
Default is \code{0.7}.#'}

\item{batch}{Batch correction option applied to the scATAC-seq preprocessing step.
Supported options:
\itemize{
  \item \code{"none"}: no batch correction (default).
  \item \code{"harmony"}: Harmony integration on the LSI reduction.
  \item \code{"seurat"}: Seurat reciprocal-LSI anchor-based integration.
}
In our practice, we do not enforce batch correction by default, because many scATAC-seq datasets are generated
within a single study and unnecessary correction may risk over-correcting. When batch effects are evident
(e.g., cells separate by batch/study in uncorrected embeddings or data are combined across studies/platforms),
we recommend using \code{batch = "harmony"}, which in our additional comparisons generally improved reliability
under pronounced cross-study heterogeneity while remaining consistent when batch effects were weak.}

\item{Batch_variable}{Metadata column name in \code{sc_dataset@meta.data} indicating batch/sample IDs used by
\code{batch = "harmony"} or \code{batch = "seurat"}. Default is \code{"Sample"}.}

\item{dim_Batch}{Dimensions used for batch correction (Harmony/Seurat integration).}
}
\value{
This function returns a Seurat-class object. It contains the results that cell state identified by
PACells as strongly associated with the clinical phenotype.
A Seurat object based on \code{sc_dataset} with an additional metadata column PACells_label
(levels: "PACells" and "Background"). Cells labeled "PACells" are those identified as most
associated with the bulk phenotype after accounting for the provided covariates.
}
\description{
\code{PACells.Covar} extends \code{PACells} by allowing users to include bulk-sample covariates when linking
a bulk phenotype to single cells. This function is intended for practical scenarios where the phenotype of
interest may be correlated with known sample-level variables (e.g., demographic variables, clinical factors,
available for bulk samples). By providing \code{covariates}, users can evaluate
phenotype-associated cells while accounting for these additional variables.
}
\details{
The function returns the input scATAC-seq Seurat object with an added metadata column
\code{PACells_label}, which labels each cell as \code{"PACells"} (selected phenotype-associated cells) or
\code{"Background"} (all other cells). In addition, the function may add intermediate dimensional reductions
and embedding (e.g., LSI, Harmony/integrated LSI, UMAP) used during the analysis.

#' \strong{Input alignment is important:}
\itemize{
  \item \code{phenotype} and \code{covariates} should follow the same bulk-sample order as in \code{bulk_dataset}.
  \item For \code{family = "cox"}, \code{phenotype} should contain two columns (\code{time} and \code{status}).
}
}
